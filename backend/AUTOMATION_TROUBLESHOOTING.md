# –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –ø—Ä–æ–±–ª–µ–º –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏–∏

## üîç –û—Å–Ω–æ–≤–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã, –ø–æ—á–µ–º—É –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è –º–æ–∂–µ—Ç –Ω–µ —Ä–∞–±–æ—Ç–∞—Ç—å

### 1. ‚ùó Cloud Scheduler –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω –∏–ª–∏ –Ω–µ –∑–∞–ø—É—â–µ–Ω (–í–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å: ~80%)

**–ü—Ä–æ–±–ª–µ–º–∞:** –í production –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è –¥–æ–ª–∂–Ω–∞ —Ä–∞–±–æ—Ç–∞—Ç—å —á–µ—Ä–µ–∑ Cloud Scheduler, –∞ –Ω–µ —á–µ—Ä–µ–∑ node-cron (–∫–æ—Ç–æ—Ä—ã–π –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç –≤ Cloud Run).

**–ü—Ä–æ–≤–µ—Ä–∫–∞:**
```bash
# –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ job
gcloud scheduler jobs describe automation-run-scheduled --location=europe-central2

# –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å—Ç–∞—Ç—É—Å (–¥–æ–ª–∂–Ω–æ –±—ã—Ç—å ENABLED)
gcloud scheduler jobs describe automation-run-scheduled --location=europe-central2 --format="value(state)"

# –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∏—Å—Ç–æ—Ä–∏—é –∑–∞–ø—É—Å–∫–æ–≤
gcloud logging read "resource.type=cloud_scheduler_job AND resource.labels.job_id=automation-run-scheduled" --limit=20
```

**–†–µ—à–µ–Ω–∏–µ:**
–ï—Å–ª–∏ job –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç, —Å–æ–∑–¥–∞–π—Ç–µ –µ–≥–æ –ø–æ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –≤ `CLOUD_SCHEDULER_SETUP.md`:
```bash
gcloud scheduler jobs create http automation-run-scheduled \
  --location=europe-central2 \
  --schedule="*/5 * * * *" \
  --uri="https://whitecoding-backend-487498983516.europe-central2.run.app/api/automation/run-scheduled" \
  --http-method=POST \
  --headers="Content-Type=application/json" \
  --time-zone="Asia/Almaty" \
  --attempt-deadline=300s \
  --oidc-service-account-email=automation-runner@videobot-478618.iam.gserviceaccount.com \
  --description="–ó–∞–ø—É—Å–∫ –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏–∏ —Ä–æ–ª–∏–∫–æ–≤ –∫–∞–∂–¥—ã–µ 5 –º–∏–Ω—É—Ç"
```

---

### 2. ‚ö†Ô∏è –ü—Ä–æ–±–ª–µ–º–∞ —Å –∏–Ω—Ç–µ—Ä–≤–∞–ª–æ–º –ø—Ä–æ–≤–µ—Ä–∫–∏ –≤—Ä–µ–º–µ–Ω–∏ (–í–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å: ~15%)

**–ü—Ä–æ–±–ª–µ–º–∞:** 
- Cloud Scheduler –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –∫–∞–∂–¥—ã–µ 5 –º–∏–Ω—É—Ç
- –§—É–Ω–∫—Ü–∏—è `shouldRunAutomation` –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –∏–Ω—Ç–µ—Ä–≤–∞–ª 6 –º–∏–Ω—É—Ç (–∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ)

**–ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç:**
- –ï—Å–ª–∏ –∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –≤—Ä–µ–º—è ‚Äî 10:00, –∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ –≤ 10:05, —Ç–æ `diffMinutes = 5`, —á—Ç–æ –ø–æ–ø–∞–¥–∞–µ—Ç –≤ –∏–Ω—Ç–µ—Ä–≤–∞–ª ‚úÖ
- –ï—Å–ª–∏ –ø—Ä–æ–≤–µ—Ä–∫–∞ –≤ 10:11, —Ç–æ `diffMinutes = 11`, –∏ –∑–∞–ø—É—Å–∫ –ø—Ä–æ–ø—É—Å—Ç–∏—Ç—Å—è ‚ùå

**–†–µ—à–µ–Ω–∏–µ:** –ò–Ω—Ç–µ—Ä–≤–∞–ª –ø—Ä–æ–≤–µ—Ä–∫–∏ —É–º–µ–Ω—å—à–µ–Ω –¥–æ 6 –º–∏–Ω—É—Ç, —á—Ç–æ–±—ã –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–æ–ø–∞–¥–∞–Ω–∏–µ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ –∫–∞–∂–¥—ã–µ 5 –º–∏–Ω—É—Ç.

---

### 3. üîí –§–ª–∞–≥ `isRunning` –∑–∞—Å—Ç—Ä—è–ª –≤ `true` (–í–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å: ~10%)

**–ü—Ä–æ–±–ª–µ–º–∞:** –ï—Å–ª–∏ –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è —É–ø–∞–ª–∞ —Å –æ—à–∏–±–∫–æ–π –∏ –Ω–µ —Å–±—Ä–æ—Å–∏–ª–∞ —Ñ–ª–∞–≥, –æ–Ω–∞ –Ω–µ –±—É–¥–µ—Ç –∑–∞–ø—É—Å–∫–∞—Ç—å—Å—è —Å–Ω–æ–≤–∞.

**–ü—Ä–æ–≤–µ—Ä–∫–∞:**
1. –û—Ç–∫—Ä–æ–π—Ç–µ Firestore Console
2. –ù–∞–π–¥–∏—Ç–µ –∫–∞–Ω–∞–ª —Å `automation.isRunning = true`
3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, –Ω–µ –∑–∞—Å—Ç—Ä—è–ª –ª–∏ –æ–Ω

**–†–µ—à–µ–Ω–∏–µ:**
–°–±—Ä–æ—Å—å—Ç–µ —Ñ–ª–∞–≥ –≤—Ä—É—á–Ω—É—é –≤ Firestore –∏–ª–∏ –¥–æ–±–∞–≤—å—Ç–µ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Å–±—Ä–æ—Å —á–µ—Ä–µ–∑ —Ç–∞–π–º–∞—É—Ç (–Ω–∞–ø—Ä–∏–º–µ—Ä, –µ—Å–ª–∏ `isRunning = true` –±–æ–ª–µ–µ 30 –º–∏–Ω—É—Ç, —Å–±—Ä–æ—Å–∏—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏).

---

### 4. üîê –ü—Ä–æ–±–ª–µ–º—ã —Å –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–µ–π Cloud Scheduler (–í–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å: ~5%)

**–ü—Ä–æ–±–ª–µ–º–∞:** –ï—Å–ª–∏ Cloud Run —Ç—Ä–µ–±—É–µ—Ç –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—é, –∞ —Å–µ—Ä–≤–∏—Å-–∞–∫–∫–∞—É–Ω—Ç –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω –ø—Ä–∞–≤–∏–ª—å–Ω–æ.

**–ü—Ä–æ–≤–µ—Ä–∫–∞:**
```bash
# –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø—Ä–∞–≤–∞ —Å–µ—Ä–≤–∏—Å-–∞–∫–∫–∞—É–Ω—Ç–∞
gcloud run services get-iam-policy whitecoding-backend --region=europe-central2

# –î–æ–ª–∂–µ–Ω –±—ã—Ç—å automation-runner@videobot-478618.iam.gserviceaccount.com —Å —Ä–æ–ª—å—é roles/run.invoker
```

**–†–µ—à–µ–Ω–∏–µ:**
```bash
gcloud run services add-iam-policy-binding whitecoding-backend \
  --member="serviceAccount:automation-runner@videobot-478618.iam.gserviceaccount.com" \
  --role="roles/run.invoker" \
  --region=europe-central2
```

---

### 5. üìä –õ–∏–º–∏—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –∑–∞–¥–∞—á –¥–æ—Å—Ç–∏–≥–Ω—É—Ç

**–ü—Ä–æ–±–ª–µ–º–∞:** –ï—Å–ª–∏ `maxActiveTasks` –¥–æ—Å—Ç–∏–≥–Ω—É—Ç, –Ω–æ–≤—ã–µ –∑–∞–¥–∞—á–∏ –Ω–µ —Å–æ–∑–¥–∞—é—Ç—Å—è.

**–ü—Ä–æ–≤–µ—Ä–∫–∞:**
–í –ª–æ–≥–∞—Ö Cloud Run –∏—â–∏—Ç–µ:
```
[Automation] ‚ö†Ô∏è  SKIPPED: Channel {id} has {count} active jobs, max is {max}
```

**–†–µ—à–µ–Ω–∏–µ:**
- –£–≤–µ–ª–∏—á—å—Ç–µ `maxActiveTasks` –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö –∫–∞–Ω–∞–ª–∞
- –ò–ª–∏ –¥–æ–∂–¥–∏—Ç–µ—Å—å –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —Ç–µ–∫—É—â–∏—Ö –∑–∞–¥–∞—á

---

## üîß –ü–æ—à–∞–≥–æ–≤–∞—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞

### –®–∞–≥ 1: –ü—Ä–æ–≤–µ—Ä—å—Ç–µ Cloud Scheduler

```bash
# –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å—Ç–∞—Ç—É—Å job
gcloud scheduler jobs describe automation-run-scheduled --location=europe-central2

# –ó–∞–ø—É—Å—Ç–∏—Ç–µ –≤—Ä—É—á–Ω—É—é –¥–ª—è —Ç–µ—Å—Ç–∞
gcloud scheduler jobs run automation-run-scheduled --location=europe-central2

# –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ Scheduler
gcloud logging read "resource.type=cloud_scheduler_job AND resource.labels.job_id=automation-run-scheduled" --limit=50
```

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:**
- Job –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –≤ —Å—Ç–∞—Ç—É—Å–µ `ENABLED`
- –í –∏—Å—Ç–æ—Ä–∏–∏ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å —É—Å–ø–µ—à–Ω—ã–µ –∑–∞–ø—É—Å–∫–∏ –∫–∞–∂–¥—ã–µ 5 –º–∏–Ω—É—Ç
- –ù–µ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –æ—à–∏–±–æ–∫ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏

---

### –®–∞–≥ 2: –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ Cloud Run

```bash
# –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏–∏
gcloud run services logs read whitecoding-backend --region=europe-central2 --limit=100 | grep "Automation"

# –ò—â–∏—Ç–µ —Å—Ç—Ä–æ–∫–∏:
# [Automation] ===== SCHEDULED AUTOMATION CHECK STARTED =====
# [Automation] Found X channels with automation enabled
# [Automation] Jobs created: X
```

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:**
- –î–æ–ª–∂–Ω—ã –±—ã—Ç—å –ª–æ–≥–∏ –∫–∞–∂–¥—ã–µ 5 –º–∏–Ω—É—Ç
- –î–æ–ª–∂–Ω—ã –±—ã—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è –æ –Ω–∞–π–¥–µ–Ω–Ω—ã—Ö –∫–∞–Ω–∞–ª–∞—Ö
- –î–æ–ª–∂–Ω—ã –±—ã—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è –æ —Å–æ–∑–¥–∞–Ω–Ω—ã—Ö –∑–∞–¥–∞—á–∞—Ö (–µ—Å–ª–∏ –≤—Ä–µ–º—è –ø–æ–¥–æ—à–ª–æ)

---

### –®–∞–≥ 3: –ü—Ä–æ–≤–µ—Ä—å—Ç–µ endpoint –≤—Ä—É—á–Ω—É—é

```bash
# –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å endpoint
curl -X POST https://whitecoding-backend-487498983516.europe-central2.run.app/api/automation/run-scheduled
```

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:**
```json
{
  "success": true,
  "timestamp": "2025-11-22T...",
  "timezone": "Asia/Almaty",
  "processed": 1,
  "jobsCreated": 0,
  "results": [...]
}
```

---

### –®–∞–≥ 4: –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∫–∞–Ω–∞–ª–∞

1. –û—Ç–∫—Ä–æ–π—Ç–µ UI –Ω–∞—Å—Ç—Ä–æ–µ–∫ –∫–∞–Ω–∞–ª–∞
2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ:
   - ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è –≤–∫–ª—é—á–µ–Ω–∞ (`automation.enabled = true`)
   - ‚úÖ –£–∫–∞–∑–∞–Ω—ã –¥–Ω–∏ –Ω–µ–¥–µ–ª–∏ (`automation.daysOfWeek.length > 0`)
   - ‚úÖ –£–∫–∞–∑–∞–Ω—ã –≤—Ä–µ–º–µ–Ω–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ (`automation.times.length > 0`)
   - ‚úÖ –ù–µ –¥–æ—Å—Ç–∏–≥–Ω—É—Ç –ª–∏–º–∏—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –∑–∞–¥–∞—á

---

### –®–∞–≥ 5: –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–Ω–æ–ø–∫—É "–ó–∞–ø—É—Å—Ç–∏—Ç—å —Å–µ–π—á–∞—Å"

1. –í UI –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∫–∞–Ω–∞–ª–∞ –Ω–∞–∂–º–∏—Ç–µ "–ó–∞–ø—É—Å—Ç–∏—Ç—å —Å–µ–π—á–∞—Å"
2. –ï—Å–ª–∏ —Ä—É—á–Ω–æ–π –∑–∞–ø—É—Å–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç ‚Äî –ø—Ä–æ–±–ª–µ–º–∞ –≤ Cloud Scheduler
3. –ï—Å–ª–∏ —Ä—É—á–Ω–æ–π –∑–∞–ø—É—Å–∫ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç ‚Äî –ø—Ä–æ–±–ª–µ–º–∞ –≤ –ª–æ–≥–∏–∫–µ –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏–∏

---

## üìã –ß–µ–∫-–ª–∏—Å—Ç –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏

- [ ] Cloud Scheduler job —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –∏ –≤–∫–ª—é—á–µ–Ω
- [ ] –°–µ—Ä–≤–∏—Å-–∞–∫–∫–∞—É–Ω—Ç `automation-runner` –∏–º–µ–µ—Ç –ø—Ä–∞–≤–∞ `roles/run.invoker`
- [ ] –í –ª–æ–≥–∞—Ö Cloud Scheduler –µ—Å—Ç—å —É—Å–ø–µ—à–Ω—ã–µ –∑–∞–ø—É—Å–∫–∏
- [ ] –í –ª–æ–≥–∞—Ö Cloud Run –µ—Å—Ç—å –ª–æ–≥–∏ –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏–∏ –∫–∞–∂–¥—ã–µ 5 –º–∏–Ω—É—Ç
- [ ] Endpoint `/api/automation/run-scheduled` –¥–æ—Å—Ç—É–ø–µ–Ω
- [ ] –ö–∞–Ω–∞–ª –∏–º–µ–µ—Ç `automation.enabled = true`
- [ ] –£–∫–∞–∑–∞–Ω—ã –¥–Ω–∏ –Ω–µ–¥–µ–ª–∏ –∏ –≤—Ä–µ–º–µ–Ω–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏
- [ ] –ù–µ –¥–æ—Å—Ç–∏–≥–Ω—É—Ç –ª–∏–º–∏—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –∑–∞–¥–∞—á
- [ ] –§–ª–∞–≥ `isRunning` –Ω–µ –∑–∞—Å—Ç—Ä—è–ª –≤ `true`
- [ ] –†—É—á–Ω–æ–π –∑–∞–ø—É—Å–∫ —á–µ—Ä–µ–∑ "–ó–∞–ø—É—Å—Ç–∏—Ç—å —Å–µ–π—á–∞—Å" —Ä–∞–±–æ—Ç–∞–µ—Ç

---

## üö® –ß–∞—Å—Ç—ã–µ –æ—à–∏–±–∫–∏

### –û—à–∏–±–∫–∞: "Service account does not exist"
```bash
# –°–æ–∑–¥–∞–π—Ç–µ —Å–µ—Ä–≤–∏—Å-–∞–∫–∫–∞—É–Ω—Ç
gcloud iam service-accounts create automation-runner \
  --display-name="Automation Runner" \
  --project=videobot-478618
```

### –û—à–∏–±–∫–∞: "Permission denied"
```bash
# –í—ã–¥–∞–π—Ç–µ –ø—Ä–∞–≤–∞
gcloud run services add-iam-policy-binding whitecoding-backend \
  --member="serviceAccount:automation-runner@videobot-478618.iam.gserviceaccount.com" \
  --role="roles/run.invoker" \
  --region=europe-central2
```

### –û—à–∏–±–∫–∞: "Job not found"
```bash
# –°–æ–∑–¥–∞–π—Ç–µ job
gcloud scheduler jobs create http automation-run-scheduled \
  --location=europe-central2 \
  --schedule="*/5 * * * *" \
  --uri="https://whitecoding-backend-487498983516.europe-central2.run.app/api/automation/run-scheduled" \
  --http-method=POST \
  --time-zone="Asia/Almaty" \
  --oidc-service-account-email=automation-runner@videobot-478618.iam.gserviceaccount.com
```

---

## üìû –ö–æ–Ω—Ç–∞–∫—Ç—ã –¥–ª—è –ø–æ–º–æ—â–∏

–ï—Å–ª–∏ –ø—Ä–æ–±–ª–µ–º–∞ –Ω–µ —Ä–µ—à–µ–Ω–∞:
1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –≤—Å–µ –ø—É–Ω–∫—Ç—ã —á–µ–∫-–ª–∏—Å—Ç–∞
2. –°–æ–±–µ—Ä–∏—Ç–µ –ª–æ–≥–∏ Cloud Scheduler –∏ Cloud Run
3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∫–∞–Ω–∞–ª–∞ –≤ Firestore
4. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–Ω–æ–ø–∫—É "–ó–∞–ø—É—Å—Ç–∏—Ç—å —Å–µ–π—á–∞—Å" –¥–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏

---

## üîÑ –ü–æ—Å–ª–µ–¥–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è

- **2025-11-22**: –£–º–µ–Ω—å—à–µ–Ω –∏–Ω—Ç–µ—Ä–≤–∞–ª –ø—Ä–æ–≤–µ—Ä–∫–∏ –≤—Ä–µ–º–µ–Ω–∏ —Å 10 –¥–æ 6 –º–∏–Ω—É—Ç –¥–ª—è –ª—É—á—à–µ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ —Å Cloud Scheduler (–∑–∞–ø—É—Å–∫ –∫–∞–∂–¥—ã–µ 5 –º–∏–Ω—É—Ç)

